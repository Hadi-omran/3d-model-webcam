<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR - Fixed Model on Surface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
</head>
<body style="margin: 0; overflow: hidden;">

<script>
    let scene, camera, renderer, model, controller;
    let hitTestSource = null;
    let hitTestSourceRequested = false;

    async function init() {
        // Setup Scene
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        // Renderer with WebXR Support
        renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // AR Button
        document.body.appendChild(
            new XRButton(renderer, { requiredFeatures: ["hit-test"] })
        );

        // AR Controller for Hit Testing
        controller = renderer.xr.getController(0);
        scene.add(controller);

        // Load 3D Model
        const loader = new THREE.GLTFLoader();
        loader.load(
            "https://modelviewer.dev/shared-assets/models/Astronaut.glb",
            function(gltf) {
                model = gltf.scene;
                model.scale.set(0.5, 0.5, 0.5);
                model.visible = false; // Initially hidden until surface is detected
                scene.add(model);
            }
        );

        animate();
    }

    function animate() {
        renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame) {
        if (frame) {
            const session = renderer.xr.getSession();
            if (!hitTestSourceRequested) {
                session.requestReferenceSpace("viewer").then((referenceSpace) => {
                    session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                        hitTestSource = source;
                    });
                });
                hitTestSourceRequested = true;
            }

            if (hitTestSource) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(renderer.xr.getReferenceSpace());
                    model.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                    model.visible = true;
                }
            }
        }

        renderer.render(scene, camera);
    }

    init();
</script>

</body>
</html>
